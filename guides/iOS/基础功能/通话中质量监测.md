<!--keywords: 质量监测,质量数据回调,网络状态,统计数据 -->
在通话场景中，开发者经常需要了解当前通话的通话质量、设备状态等信息，监测通话的整体体验；也可将部分质量数据在 UI 层面展示给用户，使用户能够及时了解当前通话的整体质量。NERTC SDK 支持将关键的音视频状况、网络状况、设备状态的相关指标实时回调给 APP 应用层，应用层可以将收到的数据进行展示或统计。

例如，在进行多人连麦时，您可以展示用户的实时网络质量，如下图所示。

<img style="width:400px" src=" https://yx-web-nosdn.netease.im/common/bc9cb52f00e1948491c5666d6db5c5c0/网络显示.png " alt="文本">

## <span id="功能介绍">功能介绍</span>

NERTC SDK 提供注册质量监测观测器 [`NERtcEngineMediaStatsObserver`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html) 的接口与相关回调方法，支持在通话中实时同步并返回质量数据，包括上下行网络质量、本地通话统计信息、本地和远端的音视频流统计信息等。

## <span id="示例项目">示例项目</span>

网易云信提供 [MediaStats 示例项目源码](https://github.com/netease-im/Advanced-Video/tree/master/MediaStats/MediaStats-iOS-ObjC)，您可以参考该源码实现通话中质量监测。

## <span id="实现方法">实现方法</span>

- 调用 [`addEngineMediaStatsObserver`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a9e692c9bd10df6ee470294f7589f0cc2) 方法注册质量观测器，主动设置相应回调，回调名称与返回的质量数据信息的对应关系如下表所示。

| 回调 | 统计信息 |
| -- | -- |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#ad7a05f151be5c68face4f695f002193a" target="_blank">`onNetworkQuality`</a> | [上下行网络质量同步](#上下行网络质量同步) |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#a97665f83f242d7f895f27616844b9f0a" target="_blank">`onRtcStats`</a> | [统计信息同步](#统计信息同步) |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#a19565a7b735c9b20ea9b02b75cae3065" target="_blank">`onLocalAudioStat`</a>、<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#ac003c8aa725ca25390ba12ecde1a5526" target="_blank">`onRemoteAudioStats`</a> | [音频质量同步](#音频质量同步) |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#a2be5316ded6ad4c103112a603eb41766" target="_blank">`onLocalVideoStat`</a>、<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#a16bdb1e9854da1c65e139bf2db9520d1" target="_blank">`onRemoteVideoStats`</a> | [视频质量同步](#视频质量同步) |

- 当您需要关闭质量监测功能时，可以调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#adb298ac23729a6c618ba99d710c51c99" target="_blank">`removeEngineMediaStatsObserver`</a> 方法删除相关 media 统计信息观测器；此外您也可以调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#ab68703f2bf2e977447dd9265feeb10d9" target="_blank">`cleanupEngineMediaStatsObserver`</a> 方法清空所有 media 统计信息观测器。

**示例代码**如下：

```objc
//添加 media 统计信息观测者
NERtcEngine *coreEngine = [NERtcEngine sharedEngine];
[coreEngine addEngineMediaStatsObserver:self];
```

以下是完整的实现示例，展示如何获取并处理各类质量数据：

```objc
#import "QualityMonitoringViewController.h"
#import <NERtcSDK/NERtcSDK.h>

@interface QualityMonitoringViewController () <NERtcEngineMediaStatsObserver>

@property (nonatomic, strong) UILabel *statsLabel;
@property (nonatomic, strong) NERtcEngine *engine;

@end

@implementation QualityMonitoringViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    // 初始化 NERtc 引擎
    self.engine = [NERtcEngine sharedEngine];
    
    // 注册质量监测观测器
    [self.engine addEngineMediaStatsObserver:self];
    
    // 设置 UI
    [self setupUI];
}

- (void)dealloc {
    // 移除质量监测观测器
    [self.engine removeEngineMediaStatsObserver:self];
}

#pragma mark - NERtcEngineMediaStatsObserver

/**
 本地通话统计回调
 包含通话时长、CPU 使用率、内存使用率、收发字节数、网络延迟、丢包率等
 */
- (void)onRtcStats:(NERtcStats *)stat {
    // SDK 回调可能在子线程，UI 更新需切换到主线程
    dispatch_async(dispatch_get_main_queue(), ^{
        NSString *statsInfo = [NSString stringWithFormat:@"通话统计 - 时长:%lds, 上行:%.2fKB, 下行:%.2fKB, CPU:%.1f%%, 上行延迟:%ldms, 下行延迟:%ldms",
                               (long)stat.totalDuration,
                               stat.txAudioKBitRate + stat.txVideoKBitRate,
                               stat.rxAudioKBitRate + stat.rxVideoKBitRate,
                               stat.cpuAppUsage,
                               (long)stat.upRtt,
                               (long)stat.downRtt];
        NSLog(@"onRtcStats: %@", statsInfo);
        [self updateStatsLabel:statsInfo];
    });
}

/**
 本地音频发送统计回调
 包含音频采样率、码率、音量、丢包率、RTT 等
 */
- (void)onLocalAudioStat:(NERtcAudioSendStats *)stat {
    dispatch_async(dispatch_get_main_queue(), ^{
        NSString *statsInfo = [NSString stringWithFormat:@"本地音频 - 采样率:%ldHz, 码率:%ldKbps, 音量:%ld, 丢包:%.1f%%, RTT:%ldms",
                               (long)stat.sentSampleRate,
                               (long)stat.kbps,
                               (long)stat.volume,
                               stat.lossRate,
                               (long)stat.rtt];
        NSLog(@"onLocalAudioStat: %@", statsInfo);
        [self updateStatsLabel:statsInfo];
    });
}

/**
 远端音频接收统计回调
 每个远端用户的音频流质量、码率、音量、卡顿率等
 */
- (void)onRemoteAudioStats:(NSArray<NERtcAudioRecvStats*> *)stats {
    dispatch_async(dispatch_get_main_queue(), ^{
        for (NERtcAudioRecvStats *audioStat in stats) {
            NSString *statsInfo = [NSString stringWithFormat:@"远端音频(uid:%llu) - 码率:%ldKbps, 音量:%ld, 卡顿率:%.1f%%, 丢包:%.1f%%",
                                   audioStat.uid,
                                   (long)audioStat.kbps,
                                   (long)audioStat.volume,
                                   audioStat.frozenRate,
                                   audioStat.lossRate];
            NSLog(@"onRemoteAudioStats: %@", statsInfo);
            [self updateStatsLabel:statsInfo];
        }
    });
}

/**
 本地视频发送统计回调
 包含视频编码分辨率、帧率、码率、编码器名称等
 */
- (void)onLocalVideoStat:(NERtcVideoSendStats *)stat {
    dispatch_async(dispatch_get_main_queue(), ^{
        NSString *layerTypeStr = stat.layerType == kNERtcStreamTypeMain ? @"主流" : @"辅流";
        NSString *statsInfo = [NSString stringWithFormat:@"本地视频(%@) - 分辨率:%dx%d, 采集帧率:%ldfps, 发送帧率:%ldfps, 码率:%ldKbps, 编码器:%@",
                               layerTypeStr,
                               (int)stat.width,
                               (int)stat.height,
                               (long)stat.captureFrameRate,
                               (long)stat.sentFrameRate,
                               (long)stat.sendBitrate,
                               stat.encoderName ?: @"未知"];
        NSLog(@"onLocalVideoStat: %@", statsInfo);
        [self updateStatsLabel:statsInfo];
    });
}

/**
 远端视频接收统计回调
 每个远端用户的视频流分辨率、帧率、码率、卡顿率等
 */
- (void)onRemoteVideoStats:(NSArray<NERtcVideoRecvStats*> *)stats {
    dispatch_async(dispatch_get_main_queue(), ^{
        for (NERtcVideoRecvStats *videoStat in stats) {
            NSString *layerTypeStr = videoStat.layerType == kNERtcStreamTypeMain ? @"主流" : @"辅流";
            NSString *statsInfo = [NSString stringWithFormat:@"远端视频(uid:%llu, %@) - 分辨率:%dx%d, 接收帧率:%ldfps, 码率:%ldKbps, 卡顿率:%.1f%%",
                                   videoStat.uid,
                                   layerTypeStr,
                                   (int)videoStat.width,
                                   (int)videoStat.height,
                                   (long)videoStat.fps,
                                   (long)videoStat.receivedBitrate,
                                   videoStat.frozenRate];
            NSLog(@"onRemoteVideoStats: %@", statsInfo);
            [self updateStatsLabel:statsInfo];
        }
    });
}

/**
 网络质量回调
 返回房间内每个用户的上下行网络质量评级
 */
- (void)onNetworkQuality:(NSArray<NERtcNetworkQualityStats *> *)stats {
    dispatch_async(dispatch_get_main_queue(), ^{
        for (NERtcNetworkQualityStats *qualityStat in stats) {
            NSString *txQualityDesc = [self qualityDescription:qualityStat.txQuality];
            NSString *rxQualityDesc = [self qualityDescription:qualityStat.rxQuality];
            NSString *statsInfo = [NSString stringWithFormat:@"网络质量(uid:%llu) - 上行:%@, 下行:%@",
                                   qualityStat.userId,
                                   txQualityDesc,
                                   rxQualityDesc];
            NSLog(@"onNetworkQuality: %@", statsInfo);
            [self updateStatsLabel:statsInfo];
        }
    });
}

#pragma mark - 辅助方法

/**
 网络质量等级转换为描述字符串
 */
- (NSString *)qualityDescription:(NERtcNetworkQuality)quality {
    switch (quality) {
        case kNERtcNetworkQualityUnknown:
            return @"未知";
        case kNERtcNetworkQualityExcellent:
            return @"极好";
        case kNERtcNetworkQualityGood:
            return @"良好";
        case kNERtcNetworkQualityPoor:
            return @"一般";
        case kNERtcNetworkQualityBad:
            return @"较差";
        case kNERtcNetworkQualityVeryBad:
            return @"很差";
        case kNERtcNetworkQualityDown:
            return @"断开";
        default:
            return @"未知";
    }
}

/**
 更新统计信息标签
 */
- (void)updateStatsLabel:(NSString *)info {
    if (self.statsLabel) {
        self.statsLabel.text = info;
    }
}

- (void)setupUI {
    // 初始化 UI 控件
    self.statsLabel = [[UILabel alloc] initWithFrame:CGRectMake(20, 100, self.view.bounds.size.width - 40, 400)];
    self.statsLabel.numberOfLines = 0;
    self.statsLabel.font = [UIFont systemFontOfSize:12];
    self.statsLabel.backgroundColor = [UIColor colorWithWhite:0.95 alpha:1.0];
    [self.view addSubview:self.statsLabel];
}

@end
```

## <span id="上下行网络质量同步">上下行网络质量同步</span>

[**`onNetworkQuality`**](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#ad7a05f151be5c68face4f695f002193a) 回调以数组的形式向您同步当前通话中每个成员的上下行网络质量。
- 上行网络质量打分基于实际发送码率、上行网络丢包率、平均往返时延和上行网络抖动计算。
- 下行网络质量打分基于下行网络丢包率、平均往返时延和下行网络抖动计算。

::: note note
- 每隔 2 秒您会收到房间内所有用户的网络质量同步。
- 实际发送码率与目标发送码率的比值越高，该网络下的通话质量越好，该网络质量打分越高。
:::

[**`NERtcNetworkQualityStats`**](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/interface_n_e_rtc_network_quality_stats.html) 数组中各参数的说明如下表所示。

<table>
<tr>
    <th width="30%">参数</th>
    <th width="70%">参数说明</th>
</tr>
    <tr>
    <td>userId</td>
    <td>用户 ID，指定是哪个用户的网络质量统计。</td>
</tr>
    <tr>
    <td>txQuality</td>
    <td>该用户的上行网络质量。</td>
</tr>
    <tr>
    <td>rxQuality</td>
    <td>该用户的下行网络质量。</td>
</tr>
</table>

其中网络质量 [**`NERtcNetworkQuality`**](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#ad7a05f151be5c68face4f695f002193a) 的各枚举值如下表所示。

<table>
<tr>
    <th width="30%">枚举值</th>
    <th width="70%">说明</th>
</tr>
    <tr>
    <td>kNERtcNetworkQualityUnknown</td>
    <td>当前网络质量未知。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityExcellent</td>
    <td>当前网络质量极好。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityGood</td>
    <td>当前网络状态不错。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityPoor</td>
    <td>当前网络状态一般。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityBad</td>
    <td>当前网络状态比较差，可能出现卡顿和网络延迟。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityVeryBad</td>
    <td>当前网络状态非常差，无法保证正常的通话质量。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityDown</td>
    <td>完全无法沟通。</td>
</tr>
</table>

## <span id="统计信息同步">统计信息同步</span>

[**`onRtcStats`**](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#a97665f83f242d7f895f27616844b9f0a) 回调向您同步本地通话统计信息。其中包含通话时长、当前通话房间中的人数、当前系统的 CPU 使用率、当前 App 的 CPU 使用率等重要数据。

<table>
<tr>
    <th width="30%">参数</th>
    <th width="70%">参数说明</th>
</tr>
    <tr>
        <td>cpuAppUsage、cpuTotalUsage</td>
        <td>App 的 CPU 使用率和系统的 CPU 使用率。</td>
    </tr>
    <tr>
        <td>memoryAppUsageRatio、memoryAppUsageInKBytes、memoryTotalUsageRatio</td>
        <td>App 的内存使用率、内存使用量、系统的内存使用率。</td>
    </tr>
    <tr>
        <td>totalDuration</td>
        <td>通话总时长，单位为秒。</td>
    </tr>
    <tr>
        <td>txBytes/rxBytes</td>
        <td>累计发送/接收字节数。</td>
    </tr>
    <tr>
        <td>txAudioBytes/rxAudioBytes</td>
        <td>音频发送/接收字节数。</td>
    </tr>
    <tr>
        <td>txVideoBytes/rxVideoBytes</td>
        <td>视频发送/接收字节数。</td>
    </tr>
    <tr>
        <td>txAudioKBitRate/rxAudioKBitRate</td>
        <td>音频接收/发送码率，单位为 Kbps。</td>
    </tr>
    <tr>
        <td>txVideoKBitRate/rxVideoKBitRate</td>
        <td>视频接收/发送码率，单位为 Kbps。</td>
    </tr>
    <tr>
        <td>upRtt/downRtt</td>
        <td>上行/下行平均往返时延，单位为毫秒。</td>
    </tr>
    <tr>
        <td>txAudioPacketLossRate/rxAudioPacketLossRate</td>
        <td>本地上行/下行音频实际丢包率。</td>
    </tr>
    <tr>
        <td>txAudioPacketLossSum/rxAudioPacketLossSum</td>
        <td>本地上行/下行音频实际丢包数。</td>
    </tr>
    <tr>
        <td>txAudioJitter/rxAudioJitter</td>
        <td>本地上行/下行音频抖动计算，单位为毫秒。</td>
    </tr>
    <tr>
        <td>txVideoJitter/rxVideoJitter</td>
        <td>本地上行/下行视频抖动计算，单位为毫秒。</td>
    </tr>
    <tr>
        <td>txVideoPacketLossRate/rxVideoPacketLossRate</td>
        <td>本地上行/下行视频实际丢包率。</td>
    </tr>
    <tr>
        <td>txVideoPacketLossSum/rxVideoPacketLossSum</td>
        <td>本地上行/下行视频实际丢包数。</td>
    </tr>
</table>

## <span id="音频质量同步">音频质量同步</span>

### <span id="本地音频流统计信息同步">本地音频流统计信息同步</span>

<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#a19565a7b735c9b20ea9b02b75cae3065" target="_blank">**`onLocalAudioStat`**</a> 回调向您同步本地设备发送音频流的统计信息，包括当前通话声道数（单声道或双声道）、发送音频的采样率和发送音频的码率。SDK 会每隔 2 秒自动触发本回调。

<table>
    <tr>
        <th width="20%"><b>参数</b></th>
        <th width="40%"><b>参数说明</b></th>
    </tr>
    <tr>
        <td>numChannels</td>
        <td>当前采集的声道数。</td>
    </tr>
    <tr>
        <td>sentSampleRate</td>
        <td>统计周期内本地上行音频采样率，单位为 Hz。</td>
    </tr>
    <tr>
        <td>kbps</td>
        <td>统计周期内发送码率的平均值，单位为 Kbps。</td>
    </tr>
    <tr>
        <td>lossRate</td>
        <td>特定时间内的音频丢包率。</td>
    </tr>
    <tr>
        <td>rtt</td>
        <td>平均往返时延（RTT）。</td>
    </tr>
    <tr>
        <td>volume</td>
        <td>音量，取值范围为 0 ~ 100。</td>
    </tr>
</table>

### <span id="远端音频流统计信息同步">远端音频流统计信息同步</span>

<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#ac003c8aa725ca25390ba12ecde1a5526" target="_blank">**`onRemoteAudioStats`**</a> 回调向您同步当前通话中每个远端用户音频流的统计信息，包括每个远端用户发送的音频流质量、声道数等信息。SDK 会每隔 2 秒自动触发本回调。

<table>
    <tbody>
        <tr>
            <td width="20%"><strong>参数</strong></td>
            <td width="40%"><strong>参数说明</strong></td>
        </tr>
        <tr>
            <td>uid</td>
            <td>用户 ID，指定是哪个用户的音频流。</td>
        </tr>
        <tr>
            <td>kbps</td>
            <td>统计周期内接收到的码率平均值，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>totalFrozenTime</td>
            <td>远端用户在加入房间后发生音频卡顿的累计时长，单位为毫秒。一个统计周期内，音频丢帧率达到 4% 即记为一次音频卡顿。</td>
        </tr>
        <tr>
            <td>frozenRate</td>
            <td>远端用户下行音频平均卡顿率。其值为远端用户在加入房间后发生音频卡顿的累计时长占音频总有效时长的百分比。</td>
        </tr>
        <tr>
            <td>lossRate</td>
            <td>统计周期内的远端音频流的丢帧率。</td>
        </tr>
        <tr>
            <td>volume</td>
            <td>音量，取值范围为 0 ~ 100。</td>
        </tr>
    </tbody>
</table>

## <span id="视频质量同步">视频质量同步</span>

### <span id="本地视频流统计信息同步">本地视频流统计信息同步</span>

<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#a2be5316ded6ad4c103112a603eb41766" target="_blank">**`onLocalVideoStat`**</a> 回调向您同步本地设备发送视频流的统计信息，包括视频编码宽/高等信息。SDK 会每隔 2 秒自动触发本回调。

如果您此前调用 [`enableDualStreamMode`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a8babba2cbaa5bc82be35136b633d28f7) 方法开启了双流模式，则本回调描述本地设备发送的视频大流的统计信息。

<table>
    <tbody>
        <tr>
            <td width="20%"><strong>参数</strong></td>
            <td width="40%"><strong>参数说明</strong></td>
        </tr>
        <tr>
            <td>layerType</td>
            <td>视频流通道类型。<li>1：主流。<li>2：辅流。</td>
        </tr>
        <tr>
            <td>width</td>
            <td>视频编码宽度，单位为 px。</td>
        </tr>
        <tr>
            <td>height</td>
            <td>视频编码高度，单位为 px。</td>
        </tr>
        <tr>
            <td>captureFrameRate</td>
            <td>视频采集帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>renderFrameRate</td>
            <td>视频渲染帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>encoderOutputFrameRate</td>
            <td>编码帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>sentFrameRate</td>
            <td>实际发送帧率，单位为 fps，不包含丢包后重传视频等的发送帧率。</td>
        </tr>
        <tr>
            <td>sendBitrate</td>
            <td>实际发送码率，单位为 Kbps，不包含丢包后重传视频等的发送码率。</td>
        </tr>
        <tr>
            <td>targetBitrate</td>
            <td>当前编码器的目标编码码率，单位为 Kbps，该码率为 SDK 根据当前网络状况预估的一个值。</td>
        </tr>
        <tr>
            <td>encoderBitrate</td>
            <td>编码器实际编码码率，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>encoderName</td>
            <td>视频编码器的名称。</td>
        </tr>
    </tbody>
</table>

### <span id="远端视频流统计信息同步">远端视频流统计信息同步</span>

<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_media_stats_observer-p.html#a16bdb1e9854da1c65e139bf2db9520d1" target="_blank">**`onRemoteVideoStats`**</a> 回调向您同步当前通话中每个远端用户/主播的视频流的统计信息，包括每个远端用户的视频宽/高等参数信息。SDK 会每隔 2 秒自动触发本回调。

<table>
    <tbody>
        <tr>
            <td width="20%"><strong>参数</strong></td>
            <td width="40%"><strong>参数说明</strong></td>
        </tr>
        <tr>
            <td>layerType</td>
            <td>视频流通道类型。<li>1：主流。<li>2：辅流。</td>
        </tr>
        <tr>
            <td>width</td>
            <td>远端视频编码宽度，单位为 px。</td>
        </tr>
        <tr>
            <td>height</td>
            <td>远端视频编码高度，单位为 px。</td>
        </tr>
        <tr>
            <td>receivedBitrate</td>
            <td>接收到的码率，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>fps</td>
            <td>接收到的帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>decoderOutputFrameRate</td>
            <td>解码帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>rendererOutputFrameRate</td>
            <td>渲染帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>packetLossRate</td>
            <td>远端视频下行丢包率。</td>
        </tr>
        <tr>
            <td>totalFrozenTime</td>
            <td>远端用户加入房间后，其下行视频卡顿累计时长，单位为毫秒。</td>
        </tr>
        <tr>
            <td>frozenRate</td>
            <td>远端用户加入房间后，其下行视频平均卡顿率，其值为视频卡顿的累计时长占视频总有效时长的百分比。</td>
        </tr>
                <tr>
            <td>decoderName</td>
            <td>视频编码器的名称。</td>
        </tr>
    </tbody>
</table>

## <span id="质量数据分析与优化建议">质量数据分析与优化建议</span>

### 网络质量评估标准

根据 `onNetworkQuality` 回调返回的网络质量等级，可以对通话质量进行评估：

| 网络质量等级 | 说明 | 建议处理 |
| -- | -- | -- |
| kNERtcNetworkQualityExcellent (极好) | 网络质量非常好，通话流畅无卡顿 | 无需特殊处理 |
| kNERtcNetworkQualityGood (良好) | 网络质量良好，通话偶尔有轻微波动 | 正常使用，持续监控 |
| kNERtcNetworkQualityPoor (一般) | 网络质量一般，可能影响音视频体验 | 建议提示用户检查网络连接 |
| kNERtcNetworkQualityBad (较差) | 网络质量较差，出现卡顿和延迟 | 建议降低视频分辨率或帧率，或切换网络 |
| kNERtcNetworkQualityVeryBad (很差) | 网络质量非常差，无法保证正常通话 | 建议切换到音频模式或更换网络环境 |
| kNERtcNetworkQualityDown (断开) | 网络连接中断 | 提示用户网络已断开，尝试重连 |

### 关键指标监控建议

1. **丢包率 (lossRate)**
   - 音频丢包率 < 5%：质量优秀
   - 音频丢包率 5% ~ 15%：质量一般，可能有轻微卡顿
   - 音频丢包率 > 15%：质量较差，需要优化网络或降低码率

2. **往返时延 (RTT)**
   - RTT < 100ms：延迟很低，体验很好
   - RTT 100ms ~ 300ms：延迟较低，体验良好
   - RTT > 300ms：延迟明显，可能影响实时性

3. **卡顿率 (frozenRate)**
   - 视频卡顿率 < 2%：流畅
   - 视频卡顿率 2% ~ 5%：有轻微卡顿
   - 视频卡顿率 > 5%：卡顿明显，需要优化

4. **帧率 (fps)**
   - 视频帧率 ≥ 24fps：流畅
   - 视频帧率 15 ~ 24fps：可接受
   - 视频帧率 < 15fps：卡顿严重

### 常见问题诊断与处理

#### 问题 1：视频卡顿频繁

**可能原因：**
- 网络带宽不足
- 下行丢包率过高
- CPU 性能不足

**排查步骤：**
1. 检查 `onRemoteVideoStats` 中的 `frozenRate` 和 `packetLossRate`
2. 如果丢包率过高，可能是网络问题
3. 检查 `onRtcStats` 中的 `cpuAppUsage`，如果 CPU 使用率过高，考虑降低分辨率或帧率

**解决方案：**
```objc
// 降低视频编码分辨率
[[NERtcEngine sharedEngine] setVideoProfile:kNERtcVideoProfile360P];

// 降低视频帧率
[[NERtcEngine sharedEngine] setLocalVideoConfig:@{@"maxFps": @15}];
```

#### 问题 2：音频断断续续

**可能原因：**
- 音频丢包率过高
- 网络抖动大

**排查步骤：**
1. 检查 `onRemoteAudioStats` 中的 `lossRate` 和 `frozenRate`
2. 检查 `onNetworkQuality` 中的网络质量等级

**解决方案：**
```objc
// 启用音频抗丢包
[[NERtcEngine sharedEngine] setParameters:@{@"key_audio_opus_fec": @1}];
```

#### 问题 3：延迟过高

**可能原因：**
- RTT 过高
- 网络拥塞

**排查步骤：**
1. 检查 `onRtcStats` 中的 `upRtt` 和 `downRtt`
2. 检查网络质量等级

**解决方案：**
```objc
// 设置更低的编码码率以降低延迟
[[NERtcEngine sharedEngine] setVideoProfile:kNERtcVideoProfile240P];
```

#### 问题 4：CPU 使用率过高

**排查步骤：**
1. 检查 `onRtcStats` 中的 `cpuAppUsage` 和 `memoryAppUsageRatio`
2. 检查是否有其他高 CPU 消耗的进程

**解决方案：**
```objc
// 降低视频编码复杂度
[[NERtcEngine sharedEngine] setParameters:@{@"key_video_encoder_complexity": @1}];

// 减少并发流数量
[[NERtcEngine sharedEngine] setParameters:@{@"key_max_video_streams": @3}];
```

### 最佳实践建议

1. **线程安全处理**
   ```objc
   // SDK 回调可能在子线程，UI 更新必须切换到主线程
   - (void)onRtcStats:(NERtcStats *)stat {
       if (![NSThread isMainThread]) {
           dispatch_async(dispatch_get_main_queue(), ^{
               // 在主线程更新 UI
           });
       }
   }
   ```

2. **资源释放**
   ```objc
   // 及时移除观测器，避免内存泄漏
   - (void)dealloc {
       [[NERtcEngine sharedEngine] removeEngineMediaStatsObserver:self];
   }
   ```

3. **数据统计与展示**
   - 不要频繁更新 UI（建议 2 秒更新一次）
   - 对质量数据进行平滑处理，避免界面抖动
   - 根据网络质量等级动态调整视频参数

4. **异常处理**
   - 设置合理的阈值，触发告警提示用户
   - 根据质量等级自动降级（如从视频切换到音频）
   - 提供网络切换建议

5. **日志记录**
   ```objc
   // 记录关键质量指标，便于问题排查
   - (void)onNetworkQuality:(NSArray<NERtcNetworkQualityStats *> *)stats {
       for (NERtcNetworkQualityStats *qualityStat in stats) {
           DDLogInfo(@"Network Quality - UID:%llu, TX:%ld, RX:%ld",
                     qualityStat.userId, (long)qualityStat.txQuality, (long)qualityStat.rxQuality);
       }
   }
   ```




